# ローカルウォーカー

## 概要

日々の通勤通学や観光の際に、ふらっと立ち寄れる地域の魅力的なスポットを提案し、地元の新たな魅力を再発見できるアプリケーション。

## 主要機能

### 発見

現在地周辺の寄り道スポットをAI提案、検索、マップで発見できる。

#### AI提案
- アプリを開くと即座におすすめのスポットをカード形式で表示
  - スポット名
  - 提案理由、マッチ度
  - ラベル（カテゴリ、同年代に人気、雰囲気など）
  - 状況（天気、気温、時間帯のアイコン）
  - 写真（統一のトーンをかけデザイン性を担保）
  - 現在地からの距離
- スワイプ操作で次々と提案を閲覧
  - 左スワイプ: 興味なし（次の提案）
  - 右スワイプ: 保存
  - タップ: 詳細表示
  - 上スワイプ: 今すぐ行く（地図表示）
- ユーザーの属性（いいね履歴、好み設定）、現在の時間帯、天気、季節、気温をAIで分析
- 足跡のキャプション、時間帯、天気、季節、気温をベクトル化
- スポットのベクトル（全足跡ベクトルの平均値）と比較し、最適なスポットを提案
- 提案理由を表示
  - 例: 「今の天気に最適」「この時間帯におすすめ」「好みの雰囲気」
- 好みの一致度を表示

#### 検索
- チャット風の自然言語検索インターフェース
- 直感的な検索が可能
  - 例: 「こってりしたラーメンが食べたい」「静かなカフェ」「雨でも楽しめる場所」
- 検索テキストと提案ベクトル（ユーザーの属性、現在の時間帯、天気、季節、気温）を組み合わせてベクトル化
- ベクトル類似度検索で最適なスポットを提案
- タイムラインでも検索機能を利用可能

#### マップ
- スポット詳細画面、検索結果画面でマップを表示
- 現在地から徒歩圏内（初期値:700m / 徒歩10分圏内）にある寄り道スポットを表示
- 市街地に近づくと自動的に情報を読み込み
- 範囲内に最大50件のスポットを表示
- 表示優先順位: アプリ内の記録 → Google Mapsのデータ（カテゴリでフィルタリング済み）
- 検索範囲はユーザーがカスタマイズ可能

#### スポット詳細画面
- 代表写真（最多いいね数の足跡画像）
- スポット名
- いいね数が最も多い足跡のキャプションを表示（将来的には複数の足跡をまとめてAI生成（バッチ処理）
- 現在地からの距離
- カテゴリ
- 保存数
- 営業時間、電話番号、ウェブサイト（Google Maps APIから取得）
- このスポットの足跡一覧
- 「このスポットを保存」ボタン
- 「足跡を記録」ボタン
- 「Google Mapsで経路検索」ボタン

#### スポット情報の更新
- ユーザーがスポット詳細を表示したときに自動更新
- 最終更新から7日以内の場合はキャッシュデータを使用
- 7日以上経過している場合はGoogle Maps APIで最新情報を取得
- 閉業情報、店名変更、移転などを自動的に反映

### 記録

立ち寄ったスポットを写真と一緒に「足跡」として記録し、公開できる。

#### 足跡の記録
- Instagramの位置情報機能と同様の選択方式
- スポット選択後に記録すると、そのスポットに紐付けられる
- 写真とキャプションを添付可能
- 訪問日時、天気、気温、季節を自動記録

#### 足跡の公開
- 公開範囲を選択可能
  - 全体公開
  - 自分のみ
- タイムラインに全体の足跡と現在地周辺の足跡を新着順に表示
- タイムラインでも検索機能を利用可能（カテゴリや雰囲気で絞り込み）

### インタラクション

#### スポットの保存
- 気になるスポットを保存し、後で見返すことが可能

#### 足跡へのいいね
- 他のユーザーが公開した足跡にいいねができる
- いいね数はスポットの代表写真選定に活用

#### 足跡の削除
- 自分が投稿した足跡を削除可能
- 削除時はスポットのaverageVectorも再計算

#### その他
- ブロック機能
- 通報機能

## その他の機能

### ユーザーオンボーディング
- 初回起動時に好みを質問（3-5個）
  - 複数選択式で回答
  - この情報を初回の提案に反映
  - ユーザープロフィールに保存（後で変更可能）
- アプリの使い方ガイド（足跡の記録方法、スポットの探し方）

### 通知機能
- 足跡へのいいね通知
- 時間ベースのスポット提案通知

### 設定
- 言語切り替え（日本語/英語）
- プロフィール編集
- 好み設定の変更
- パスワード変更
- 通知設定（ON/OFF、種類のカスタマイズ）

## 認証方法
- メール・パスワード認証
- Googleアカウント認証
- Apple ID認証

## データベース設計

### Users
```
userId, username, email, profilePhotoUrl
blockedUserIds
birthDate, gender
preferences
settings
createdAt, updatedAt
hasOnboarded
```

### Spots
```
spotId (Google Place ID)
name, location, categories
coverPhotoUrl
description
averageVector
footprintCount, savesCount
businessStatus, lastUpdated
```

### Footprints
```
footprintId, spotId, authorId
photoUrls, caption
visitDate, weather, timeOfDay, season, temperature
authorGender, authorAge
embedding
visibility
likesCount
```

### Likes
```
likeId, footprintId, authorId, createdAt
```

### Saves
```
saveId, spotId, authorId, createdAt
```

### Notifications
```
notificationId, userId, type, fromUserId, relatedId, isRead, createdAt
```

### Reports
```
reportId, targetId (footprintId or userId), reason, reporterId, reportDate
```

## 技術スタック

### フロントエンド
- **Flutter**: クロスプラットフォーム対応（iOS/Android）

### バックエンド
- **Firebase Authentication**: ユーザー認証（Email/Password、Google、Apple）
- **Cloud Firestore**: データベース
- **Firebase Storage**: 画像ファイルの保存
- **Cloud Functions**: サーバーサイド処理（ベクトル化、データ集計など）
- **Firebase Cloud Messaging**: プッシュ通知

### 外部API
- **Google Maps Platform**
  - Maps SDK for Flutter: マップ表示
  - Places API: スポット情報取得
- **天気API**（OpenWeatherMap / Weather APIなど）: 天気情報取得
- **Vertex AI**: テキストのベクトル化（Text Embeddings API）

## 将来の実装予定

- 営業時間を考慮した検索
- 所要時間の表示
- Google Maps口コミの統合
- より詳細なフィルタリング
- ミッション機能（地域タイアップ、ローカルガイド、アプリ定着促進）
- プレミアム機能
  - 無制限スポット保存
  - AI提案の優先アクセス
  - 広告非表示

## メモ

### Vertex AI実装

#### 基本構成
- **モデル**: text-embedding-gecko@003 または text-embedding-004
- **入力**: 足跡のキャプション + 時間帯 + 天気 + 季節 + 気温を結合したテキスト
- **出力**: 768次元のベクトル

#### ベクトル化用テキストの生成
- Cloud Functions内でテンプレート文字列を使用
- 性別・年代はベクトル化に含めず、別フィールドとして保存し、表示時に「同年代にも人気」と表記
- **時間帯**: `朝` `昼` `午後` `夜` の4区分
- **天気**: `晴れ` `曇り` `雨` `雪` の4区分
- **季節**: `春` `夏` `秋` `冬` の4区分（訪問日時から自動計算）
  - 春: 3-5月、夏: 6-8月、秋: 9-11月、冬: 12-2月
- **気温**: `寒い` `涼しい` `暖かい` `暑い` の4区分（天気APIから取得）
  - 寒い: 0-10度、涼しい: 11-18度、暖かい: 19-25度、暑い: 26度以上

#### 実装フロー
1. ユーザーが足跡を投稿 → Cloud Functions トリガー
2. テンプレートでベクトル化用テキスト生成
3. Cloud FunctionsからVertex AI APIを呼び出し
4. 生成されたベクトルをFootprintsテーブルのembeddingフィールドに保存
5. スポットの全足跡ベクトルの平均を計算しSpotsテーブルのaverageVectorに保存

#### バッチ化の実装
- 複数の足跡を1回のAPIリクエストで処理
- Vertex AI APIは複数テキストを配列で送信可能
- 例: 10件の足跡 → 1回のAPI呼び出しで10個のベクトルを取得

#### ベクトル類似度検索
**検索フロー**:
1. 現在地周辺（デフォルト700m、ユーザー調整可能）のスポットを取得
2. ユーザーの検索クエリ・属性・時間帯・天気・季節・気温をVertex AIでベクトル化
3. 各スポットのaverageVectorを計算、コサイン類似度をFirestoreのfindNearestクエリで検索
4. 類似度スコアでソート（降順）
5. 上位N件を提案として表示

**コサイン類似度の計算**:
- 2つのベクトルの類似度を-1〜1で表現（1に近いほど類似）
- Cloud Functions内で計算: `dotProduct / (norm1 * norm2)`
- 計算コスト: O(n) × スポット数（50件程度なら問題なし）

**距離とベクトルのバランス**:
- 初期実装: ベクトル類似度のみでランキング（距離は検索範囲の絞り込みのみ）
- 将来実装: ベクトル類似度と距離を組み合わせたスコアリング

#### コスト最適化
- **バッチ処理**: 複数の足跡をまとめて1回のAPI呼び出しで処理
- **スポットaverageVectorの更新**: 数学的な差分計算
- **検索クエリのベクトル化**: クライアント側でキャッシュ
- **非同期処理**: 足跡投稿直後にベクトル化しなくてもよい場合はバックグラウンドで処理
- **提案理由**: テンプレート
- **スポット紹介文**: 初期は足跡から抽出、将来的に生成

### セキュリティ

#### Firestore Security Rules
- 自分の足跡のみ編集可能
- visibilityフィールドに応じた閲覧制限
  - "public": 全員が閲覧可能
  - "private": 本人のみ閲覧可能
- preferences, isLocalGuide は本人のみ編集可能

#### 画像のモデレーション
- **Cloud Vision API**で不適切な画像を自動検出
  - Safe Search Detection: アダルト、暴力、医療などのコンテンツを検出
  - アップロード時に自動スキャン
  - 不適切と判定された画像は投稿をブロック
- ユーザーによる通報機能も併用

#### スパム対策
- レートリミット: 1日の投稿数制限（例:20件/日）
- 短時間での大量投稿を検知してブロック

### パフォーマンス最適化

#### 画像の最適化
- アップロード時のリサイズ（Cloud Functions）
  - 最大解像度: 1080x1080px
  - JPEG品質: 80%
- サムネイル生成: 300x300px
- 遅延読み込み

#### キャッシュ戦略
- Firestoreのオフラインキャッシュ活用
- スポット情報のローカルキャッシュ（7日間有効）
- 最大表示件数の制限（50件）

#### インデックス設計
- Firestoreの複合インデックスを適切に設定

#### Vertex AI
- ベクトル化処理のバッチ化（複数の足跡をまとめて処理）
- リクエスト回数とトークン数の最適化

### データ整合性

#### スポット情報の更新
- ユーザーがスポット詳細を表示した際に自動更新
- 閉業スポットの非表示化

#### ベクトルの再計算
- 足跡追加時: 数学的な差分計算でスポットベクトルを更新
- 足跡削除時: スポットのaverageVectorを再計算

#### カウント管理
- いいね数・保存数はCloud Functionsで管理

#### 初期データ問題への対策
- リリース直後は足跡データが少ないため、ベクトル検索の精度が低い
- 対策1: 初期は距離順・カテゴリ別表示を優先
- 対策2: ベータテスターに全国各地で足跡記録を依頼し、初期データを蓄積
- 対策3: スポットに足跡がない場合は、Google Mapsのカテゴリから簡易的なベクトルを生成

### UX/UI

#### 位置情報の取得
- フォアグラウンドでの位置情報取得
- 位置情報の更新頻度: 移動検知時またはマップ操作時
- バッテリー節約の工夫:
  - 静止時: 位置情報取得を停止
  - 移動検知: 加速度センサーで移動を検知したら位置更新
  - マップ操作時: ユーザーがマップを動かしたら周辺スポットを更新

#### オフライン対応
- 保存済みスポットのオフライン閲覧
- 足跡の一時保存と自動同期
  - ネットワークがない場所でも足跡を記録可能
  - 位置情報、写真、キャプションを端末のローカルストレージに保存
  - オンラインに戻ったら自動的にFirestoreに同期
  - Firestoreのオフライン機能を活用

### 分析

- **Firebase Analytics**: ユーザー行動の追跡
- **Crashlytics**: クラッシュレポートの収集
- **Performance Monitoring**: アプリパフォーマンスの監視
- **カスタムイベント**:
  - スポット発見率
  - 足跡記録率
  - いいね・保存の頻度
  - スワイプ操作の傾向
  - 検索利用率

### テスト

- **単体テスト**: Flutter Widgetテスト
- **統合テスト**: Firebase Emulator Suiteを使用
- **E2Eテスト**: Flutter Integration Test
- **セキュリティルールのテスト**: Firestore Security Rulesのユニットテスト